
---

# 功能开发需求文档 v1

**模块**：预设（系统提示词）— 测试结果存档与可视化  
**目标**：
- 在预设详情页右侧新增「测试结果」区域
- 支持一键并行测试（沿用现有逻辑）与手动保存本次测试结果到数据库
- 统计维度：按模型分布（次数、通过/失败、通过率）、错误类型分布
- 图表：模型对比柱状图、严重度堆叠柱状图、错误类型饼图（ECharts）
- 支持历史记录列表与 CSV 导出（论文/报告截图用）

---

## 1. 页面与交互（前端）

**位置**：预设管理器右侧详情面板下方。

### 1.1 UI 结构（示例）
```
<section id="preset-test-results" class="card">
  <header class="card-header">
    <h3>📊 测试结果（按模型统计）</h3>
    <div class="actions">
      <button id="btn-run-parallel-test">运行并行测试</button>
      <button id="btn-save-current-result" disabled>保存本次测试结果</button>
      <button id="btn-export-csv" disabled>导出CSV</button>
    </div>
  </header>

  <div class="stats-summary">
    <div><b>总测试用例：</b><span id="sum-total">-</span></div>
    <div><b>参与模型：</b><span id="sum-models">-</span></div>
    <div><b>整体通过率：</b><span id="sum-pass-rate">-</span></div>
  </div>

  <div class="charts">
    <div id="chart-model-compare" style="width:100%;height:280px;"></div>
    <div id="chart-severity-stacked" style="width:100%;height:280px;margin-top:12px;"></div>
    <div id="chart-error-pie" style="width:100%;height:280px;margin-top:12px;"></div>
  </div>

  <div class="top-errors">
    <label for="top-errors-model"><b>Top 错误类型（按模型）：</b></label>
    <select id="top-errors-model"></select>
    <div id="top-errors-table"></div>
  </div>

  <div class="history">
    <h4>历史测试记录</h4>
    <ul id="history-list"></ul>
  </div>
</section>
```

### 1.2 交互流程
1) 选择预设 → 右侧详情显示。  
2) 点击「运行并行测试」→ 复用现有并行测试逻辑获得 `results[]`。  
3) 前端聚合 `results`，更新摘要/图表，启用「保存本次测试结果」。  
4) 点击「保存本次测试结果」→ POST 数据库（只存统计 JSON 与元信息）。  
5) 保存成功后刷新历史列表，启用「导出CSV」。  
6) 点击「导出CSV」→ 导出聚合后的统计结果。

---

## 2. 数据统计逻辑（前端聚合）

输入示例（沿用并行测试返回，每条代表模型的一次样例）：
```js
[
  { preset_id: 12, model: "deepseek-chat", sample_id: "s-001", errors: ["角色违偏"], score: 0.9, latency_ms: 2300 },
  { preset_id: 12, model: "qwen-max", sample_id: "s-001", errors: [] }
]
```

输出示例（用于可视化与保存）：
```js
{
  meta: {
    preset_id: 12,
    models_tested: ["deepseek-chat","qwen-max"],
    total_samples: 40,
    created_at: "2025-10-28T17:25:00+09:00"
  },
  statistics: {
    "deepseek-chat": {
      total: 20, pass: 16, fail: 4, passRate: 80,
      errors: { "角色违偏": 2, "输出不完整": 1, "逻辑错误": 1 }
    },
    "qwen-max": {
      total: 20, pass: 18, fail: 2, passRate: 90,
      errors: { "格式错误": 1, "语义不符": 1 }
    }
  }
}
```

聚合函数放置：`js/parallel-test/analyzer.js`（已含 CSV 导出与 ECharts 渲染）。

---

## 3. 后端接口
- 已有：`POST /api/experiments` 保存统计结果；`GET /api/experiments?preset_id=...` 拉取历史。  
- 新增/已有：`/api/test-runs` 系列（如有需要）用于新版并行运行流水。  
- 鉴权：沿用 JWT 中间件，仅允许当前登录用户访问自己的数据。

表结构示例（已在 `migrations.sql` 中）：`experiment_results` 表存 `user_id/preset_id/models/statistics/json`。

---

## 4. 验收清单
- [ ] 预设详情页新增「测试结果」区域。  
- [ ] 运行并行测试后，图表和摘要可视化正常显示。  
- [ ] 保存结果成功写入数据库，历史列表按时间倒序显示。  
- [ ] 导出 CSV 含模型、总数、通过/失败、通过率、错误分布 JSON。  
- [ ] 接口鉴权正常，异常参数返回友好错误。  
- [ ] 文字/编码均为 UTF-8，无乱码。

---

## 5. 实现顺序
1) DB：确保 `experiment_results` 表存在且字段正确。  
2) 后端：接口校验与鉴权；必要时增加 test-runs 汇总接口。  
3) 前端：聚合函数与图表渲染（ECharts）；按钮与历史列表交互。  
4) CSV 导出与错误提示；完成自测流程。

---

